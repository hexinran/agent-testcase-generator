# 难度分级详解

本文档详细说明测试用例的难度分级标准和设计要点。

---

## 难度定义表

| 难度 | Golden Action 步数 | 环境文件数 | Query 特点 | 信息分散度 | 干扰项数量 |
|------|-------------------|-----------|-----------|-----------|-----------|
| **D2** | 1-2步 | 3-5个 | 直接告诉文件路径和操作 | 单文件或相邻文件 | 0个 |
| **D3** | 3-4步 | 8-12个 | 告诉目标，路径需探索 | 1-2个文件 | 1-2个 |
| **D4** | 5-6步 | 12-15个 | 描述现象，需分析推断 | 3+个文件 | 3-5个 |
| **D5** | 7-8步 | 15-20个 | 模糊描述，需多处拼凑 | 4+个文件 | 5-8个 |
| **D6** | 9-10步 | 20-25个 | 用户反馈，深度分析 | 5+个文件 | 8-12个 |
| **D7** | 11-15步 | 25-35个 | 极度模糊，跨子系统 | 6+个文件 | 12+个 |

---

## 难度来源

测试题的难度由以下因素共同决定：

1. **信息分散程度**：答案需要从多少个文件中拼凑
2. **干扰信息数量**：有多少个干扰文件和红鲱鱼
3. **推理链条长度**：从线索到答案需要多少步推理
4. **Query 模糊度**：Query 给出的信息有多明确
5. **环境复杂度**：项目结构的复杂程度

---

## D2：入门级（1-2步）

### 特征

- **最简单**：适合验证工具基本使用能力
- **直接明确**：Query 直接告诉文件路径或操作
- **信息集中**：所有信息在 1-2 个相邻文件中

### Query 示例

```
"请将 config/app.yaml 中的端口从 8080 改为 8081"
```

### 环境示例

```
config/
  app.yaml           # 包含 port: 8080
logs/
  app.log            # 简单日志
README.md            # 项目说明
```

### Golden Action 示例

```json
[
  {"tool": "Read", "input": {"file_path": "config/app.yaml"}},
  {"tool": "Edit", "input": {"file_path": "config/app.yaml", "old_string": "port: 8080", "new_string": "port: 8081"}}
]
```

### 设计要点

- ✅ Query 直接告诉文件路径
- ✅ 只需要简单的读取和修改
- ✅ 无需推理和探索
- ✅ 适合验证工具基本功能

---

## D3：基础级（3-4步）

### 特征

- **需要探索**：Query 告诉目标，但不告诉具体路径
- **信息分散**：关键信息在 1-2 个文件中
- **简单推理**：需要简单的搜索和推断
- **少量干扰**：1-2 个干扰文件

### Query 示例

```
"订单服务连接数据库超时，请修复配置"
```

### 环境示例

```
services/
  order-service/
    config.yaml          # 包含错误的 timeout: 5000
    app.py
logs/
  error.log               # 显示 "connection timeout"
  access.log
docs/
  README.md
  troubleshooting.md      # 建议 timeout: 30000
config/
  database.yaml           # 干扰项（不是问题所在）
```

### Golden Action 示例

```json
[
  {"tool": "Read", "input": {"file_path": "logs/error.log"}},
  {"tool": "Grep", "input": {"pattern": "timeout", "output_mode": "files_with_matches"}},
  {"tool": "Read", "input": {"file_path": "docs/troubleshooting.md"}},
  {"tool": "Edit", "input": {"file_path": "services/order-service/config.yaml", "old_string": "timeout: 5000", "new_string": "timeout: 30000"}}
]
```

### 设计要点

- ✅ Query 描述问题现象，不给文件路径
- ✅ 需要通过日志定位问题
- ✅ 需要搜索找到相关配置
- ✅ 正确值可以从文档中找到

---

## D4：中级（5-6步）

### 特征

- **多步推理**：需要从多个文件拼凑信息
- **信息分散**：关键信息分散在 3+ 个文件
- **明显干扰**：3-5 个干扰文件和红鲱鱼
- **答案不可预测**：答案值必须从环境获取

### Query 示例

```
"生产环境支付服务响应慢，用户投诉超时。请根据监控日志和故障单排查配置问题"
```

### 环境示例

```
services/
  payment-service/
    config/application.yaml     # 包含错误配置
    config/application.yaml.bak # 干扰项
  gateway/
    routes.yaml                 # 干扰项（看起来相关）
logs/
  payment.log                   # 显示超时
  gateway.log                   # 红鲱鱼（显示 rate limit）
  database.log                  # 红鲱鱼（显示 slow query）
docs/
  incidents/
    INC-2847.md                 # 故障单，给出推荐配置
    INC-2846.md                 # 干扰项
  architecture.md
monitoring/
  metrics.yaml                  # 性能数据
config/
  production.yaml               # 环境配置
  staging.yaml                  # 干扰项
```

### Golden Action 示例

```json
[
  {"tool": "Read", "input": {"file_path": "logs/payment.log"}},
  {"tool": "Grep", "input": {"pattern": "timeout", "output_mode": "files_with_matches"}},
  {"tool": "Read", "input": {"file_path": "docs/incidents/INC-2847.md"}},
  {"tool": "Read", "input": {"file_path": "monitoring/metrics.yaml"}},
  {"tool": "Read", "input": {"file_path": "services/payment-service/config/application.yaml"}},
  {"tool": "Edit", "input": {"file_path": "services/payment-service/config/application.yaml", ...}}
]
```

### 设计要点

- ✅ 信息分散在：logs/ → docs/ → monitoring/ → config/
- ✅ 有多个红鲱鱼（gateway 限流、数据库慢查询）
- ✅ 正确的超时值从故障单（INC-2847）获取，不可预测
- ✅ 需要排除干扰项（.bak 文件、staging 配置）

---

## D5：高级（7-8步）

### 特征

- **复杂拼凑**：需要从 4+ 个文件深度挖掘信息
- **模糊 Query**：Query 非常模糊，需要大量探索
- **深度嵌套**：信息藏在深层目录中
- **多重推理**：需要多层推理才能找到答案

### Query 示例

```
"生产环境订单系统出现间歇性故障，部分用户反馈下单失败。
请根据监控数据、日志和最近的系统变更记录全面排查。"
```

### 环境示例

```
15-20 个文件，包括：
- 多层嵌套的服务目录
- 多个日志文件（分散在不同服务）
- 故障单、变更记录、架构文档
- 多个配置文件（生产、预发、开发）
- 监控数据、性能报告
- 大量干扰文件（5-8 个）
```

### Golden Action 示例

7-8 步，涉及多个服务和配置文件的探索。

### 设计要点

- ✅ Query 非常模糊（"间歇性故障"）
- ✅ 需要从多个角度分析（监控、日志、变更记录）
- ✅ 信息深度嵌套（services/backend/payment/config/prod/...）
- ✅ 答案需要从多个文档拼凑

---

## D6：专家级（9-10步）

### 特征

- **极度复杂**：信息分散在 5+ 个文件
- **用户反馈场景**：Query 来自真实用户反馈
- **需要深度分析**：需要分析日志、代码、配置、监控
- **跨服务推理**：问题涉及多个服务的交互

### Query 示例

```
"客户反馈：下单后支付成功，但订单状态一直是待支付，
联系客服后发现订单系统和支付系统数据不一致。
请排查生产环境配置，找出数据不同步的根因。"
```

### 环境示例

```
20-25 个文件，包括：
- 多个微服务（order、payment、notification）
- 服务间通信配置（消息队列、API）
- 多处日志（各服务的日志）
- 监控和告警配置
- 数据同步配置
- 大量干扰文件（8-12 个）
```

### 设计要点

- ✅ Query 来自用户视角（不是技术描述）
- ✅ 需要理解服务间交互
- ✅ 需要分析数据流
- ✅ 问题涉及配置同步、消息队列等复杂场景

---

## D7：大师级（11-15步）

### 特征

- **超高复杂度**：信息分散在 6+ 个文件
- **极度模糊**：Query 几乎没有技术细节
- **跨子系统**：涉及多个子系统的配置和交互
- **需要系统性分析**：需要全面理解架构

### Query 示例

```
"生产环境核心业务功能出现严重故障，影响大量用户。
监控显示多个指标异常，但根因不明。
请紧急排查所有相关系统配置，找出问题并修复。"
```

### 环境示例

```
25-35 个文件，包括：
- 完整的微服务架构（5+ 个服务）
- 基础设施配置（数据库、缓存、消息队列、网关）
- 多层级的配置文件
- 大量日志和监控数据
- 架构文档、故障案例库
- 大量干扰文件（12+ 个）
```

### 设计要点

- ✅ Query 极度模糊，只描述业务影响
- ✅ 需要系统性排查多个子系统
- ✅ 信息深度隐藏，需要多次推理
- ✅ 适合测试 Agent 的全局架构理解能力

---

## 难度选择建议

| 场景 | 推荐难度 | 理由 |
|------|---------|------|
| 验证工具基本功能 | D2 | 简单直接，快速验证 |
| 日常开发任务 | D3-D4 | 贴近真实场景 |
| 线上故障排查 | D4-D5 | 需要推理和探索 |
| 复杂系统调试 | D5-D6 | 高级推理能力 |
| 架构级问题诊断 | D6-D7 | 系统性分析能力 |

---

## 难度验证方法

设计完成后，通过以下方式验证难度是否合理：

1. **Golden Action 步数**：是否符合难度要求
2. **环境文件数**：是否符合难度要求
3. **信息分散度**：关键信息是否分散在足够多的文件中
4. **Haiku 表现**：
   - D2-D3：Haiku 应该能通过
   - D4-D5：Haiku 可能通过，步数接近 Golden Action
   - D6-D7：Haiku 可能失败（能力不足）

---

## 常见错误

### 错误 1：文件数够，但信息不够分散

```
❌ 环境有 15 个文件，但答案都在 config.yaml 的注释中
✅ 信息分散在：logs/ → docs/ → config/ → monitoring/
```

### 错误 2：步数够，但没有实质性探索

```
❌ 10 步都是 Read，只是在读文件，没有推理
✅ 包含探索（Read/Grep）+ 推理（阅读文档）+ 行动（Edit）
```

### 错误 3：干扰项太明显

```
❌ file.yaml.bak（一眼看出是备份）
✅ config-v2.yaml, config-legacy.yaml（需要判断哪个是当前使用）
```

---

## 总结

选择难度时考虑：

1. **目标 Agent 能力**：训练什么级别的 Agent
2. **场景真实性**：是否贴近真实任务
3. **验证成本**：高难度题目验证成本更高
4. **数据分布**：各难度题目数量的平衡

**推荐分布**：
- D2-D3：20%（基础验证）
- D4-D5：50%（主要场景）
- D6-D7：30%（高级能力）
