# Explore 视角（Plan 模式）

## 定义

**Explore 视角**：用户不确定具体要做什么，需要 Agent 先探索调研再规划执行。

对应 Claude 的 **EnterPlanMode** 工具。

## 特点

- 涉及多个文件的协调修改
- 需要先规划再执行
- 强调闭环验证（新增 + 删除 + 引用更新）

---

## Plan 模式 vs 普通模式

| 维度 | 普通模式 | Plan 模式 |
|-----|---------|-----------|
| **文件操作** | 单文件或少量文件 | 多文件协调 |
| **任务复杂度** | 直接执行 | 需要规划 |
| **视角** | todo / reference | explore |
| **验证重点** | 内容正确 | 结构变化 + 引用一致 |
| **难度等级** | D2-D7 | Plan-D4 ~ Plan-D7 |

---

## 适用场景

### 1. 代码重构
- 模块拆分：将大模块拆分为多个小模块
- 函数提取：将重复代码提取为公共函数
- 代码移动：将代码从一个位置移动到另一个位置

### 2. 配置迁移
- 环境迁移：从开发环境配置生成生产环境配置
- 格式迁移：从旧配置格式迁移到新格式
- 集中化：将分散的配置集中到统一位置

### 3. API 升级
- 版本升级：从 v1 API 升级到 v2 API
- 废弃替换：替换废弃的 API 调用
- 接口重构：重构内部接口定义

---

## 难度定义

| 难度 | 文件数 | 操作范围 | 验证点 |
|------|--------|---------|--------|
| Plan-D4 | 6-10 个 | 2-3 个文件变更 | 3-4 个 |
| Plan-D5 | 10-15 个 | 4-6 个文件变更 | 4-6 个 |
| Plan-D6 | 15-20 个 | 6-10 个文件变更 | 6-8 个 |
| Plan-D7 | 20+ 个 | 10+ 个文件变更 | 8+ 个 |

---

## Query 设计指南

### 核心目标：触发 EnterPlanMode

Plan 模式的 Query 必须设计得让 Agent 意识到：**这个任务需要先规划再执行**。

### 触发 Plan 模式的关键要素

| 要素 | 说明 | 示例表达 |
|-----|------|---------|
| **多文件操作** | 暗示需要修改多个文件 | "更新所有引用"、"涉及多个模块" |
| **结构变化** | 暗示目录/架构调整 | "重构"、"迁移"、"拆分" |
| **依赖关系** | 暗示修改有连锁影响 | "确保一致性"、"不破坏现有功能" |
| **复杂度信号** | 暗示需要思考 | "设计方案"、"规划步骤" |

### 触发词汇表

**强触发词**（高概率触发 EnterPlanMode）：
- "重构"、"迁移"、"拆分"、"合并"
- "设计一个方案"、"规划实施步骤"
- "涉及多个文件"、"更新所有相关引用"
- "确保架构一致性"、"不影响现有功能"

**弱触发词**（可能不触发）：
- "修改"、"更新"、"修复"（太简单）
- 直接指定文件和操作（太具体）

### Query 示例对比

**不好（太直接，可能不触发 Plan）**：
```
把 src/utils.py 里的 format_date 函数复制到 src/helpers/date.py
```

**好（触发 Plan 模式）**：
```
将 src/utils.py 中的日期处理相关函数提取到独立模块，
重构后需要更新所有引用这些函数的文件，确保测试仍然通过。
```

---

## Grader 设计

### 必须验证 EnterPlanMode

```json
{
  "type": "tool_calls",
  "required": [
    {"tool": "EnterPlanMode", "description": "必须进入 Plan 模式进行规划"}
  ]
}
```

### 闭环验证原则

```
闭环 = 新增 + 删除 + 引用更新

示例（模块拆分）：
1. 新增：新模块文件存在
2. 删除：原文件中的代码已移除
3. 引用更新：所有 import 语句已更新
```

详细 Grader 模板见：`perspective/explore_graders.md`
